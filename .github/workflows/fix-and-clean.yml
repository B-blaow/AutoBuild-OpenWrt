name: Fix and Cleanup Runner for OpenWrt

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  fix_and_clean:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: BEFORE — Disk Usage
        run: |
          echo "=== BEFORE CLEANUP ==="
          df -h
          du -h --max-depth=1 / \
            --exclude=/proc \
            --exclude=/sys \
            --exclude=/dev \
            2>/dev/null | sort -hr | head -n 20

      # ============================================================
      # Smart Runner Health Check
      # ============================================================
      - name: Smart Runner Health Check
        run: |
          echo "=== Checking runner health ==="
          echo "--- Checking hostedtoolcache ---"
          ls -al /opt/hostedtoolcache || echo "hostedtoolcache missing"

          echo "--- Checking essential tools ---"
          which cmake || echo "cmake missing"
          which ninja || echo "ninja missing"
          which python3 || echo "python3 missing"
          which pkg-config || echo "pkg-config missing"

          echo "--- Checking pkg-config functionality ---"
          pkg-config --version || echo "pkg-config broken"
          pkg-config --libs glib-2.0 || echo "glib-2.0 missing"
          pkg-config --libs dbus-1 || echo "dbus-1 missing"

          echo "--- Checking compiler ---"
          gcc --version || echo "gcc missing"
          g++ --version || echo "g++ missing"

          echo "--- Checking environment summary ---"
          env | sort

      # ============================================================
      # Restore OpenWrt build dependencies
      # ============================================================
      - name: Restore OpenWrt host build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gcc \
            gettext \
            git \
            libncurses5-dev \
            libssl-dev \
            python3 \
            python3-pip \
            python3-setuptools \
            rsync \
            unzip \
            zlib1g-dev \
            file \
            wget \
            curl \
            cmake \
            ninja-build \
            pkg-config \
            libglib2.0-dev \
            libdbus-1-dev \
            libelf-dev \
            libtool \
            autoconf \
            automake \
            perl

      # ============================================================
      # Force clean OpenWrt build directories
      # ============================================================
      - name: Force clean broken OpenWrt build environment
        run: |
          rm -rf staging_dir || true
          rm -rf build_dir || true
          rm -rf tmp || true

      # ============================================================
      # Safe Cleanup (does not break OpenWrt)
      # ============================================================
      - name: Clean system components (safe)
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/lib/android || true
          # DO NOT delete /opt/hostedtoolcache
          # DO NOT delete /home/linuxbrew/.linuxbrew

      - name: Clean Docker
        run: |
          sudo docker system prune -af || true

      - name: Clean APT / logs / temp
        run: |
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo rm -rf /var/log/*
          sudo rm -rf /tmp/* /var/tmp/*

      - name: Clean /mnt except swapfile
        run: |
          sudo find /mnt -mindepth 1 -maxdepth 1 ! -name swapfile -exec rm -rf {} +
          sudo mkdir -p /mnt
          sudo chown $USER:$USER /mnt

      # ============================================================
      # AFTER — Disk Usage
      # ============================================================
      - name: AFTER — Disk Usage
        run: |
          echo "=== AFTER CLEANUP ==="
          df -h
          du -h --max-depth=1 / \
            --exclude=/proc \
            --exclude=/sys \
            --exclude=/dev \
            2>/dev/null | sort -hr | head -n 20

      - name: Done
        run: echo "✅ Fix + Cleanup + Smart Runner Check completed"
